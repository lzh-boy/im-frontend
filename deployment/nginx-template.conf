# OpenIM CMS 反向代理配置文件模板
# 使用方法：替换 {{SERVER_IP}} 为实际的服务器IP地址

# 管理后台服务 (端口 10009)
upstream admin_backend {
    server {{SERVER_IP}}:10009;
}

# 用户服务 (端口 10008)
upstream user_backend {
    server {{SERVER_IP}}:10008;
}

# IM 系统服务 (端口 10002)
upstream im_backend {
    server {{SERVER_IP}}:10002;
}

server {
    listen 80;
    server_name localhost;
    
    # 客户端最大请求体大小
    client_max_body_size 100M;
    
    # 代理超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 通用代理头设置
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # ==================== 管理后台相关接口 ====================
    location /api/account {
        proxy_pass http://admin_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    location /api/user/password {
        proxy_pass http://admin_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    location /api/user/import {
        proxy_pass http://admin_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    location /api/block {
        proxy_pass http://admin_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    location /api/default {
        proxy_pass http://admin_backend;
        rewrite ^/api(.*)$ $1 break;
    }

    # ==================== IM 系统相关接口 ====================
    # IM 用户列表接口 (必须在 /api/user 之前)
    location /api/user/get_users {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # ==================== 用户服务相关接口 ====================
    # 用户管理相关接口 (必须在最后，因为会匹配所有 /api/user/* 路径)
    location /api/user {
        proxy_pass http://user_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 消息相关接口
    location /api/msg {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 群组管理接口
    location /api/group {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 认证相关接口
    location /api/auth {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 好友关系接口
    location /api/friend {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 第三方服务接口（客户端日志等）
    location /api/third {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # 对象存储接口
    location /api/object {
        proxy_pass http://im_backend;
        rewrite ^/api(.*)$ $1 break;
    }
    
    # ==================== 静态文件服务 ====================
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    
    # 错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
